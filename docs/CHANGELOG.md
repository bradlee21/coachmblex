# Changelog

## 2026-02-20
- TP-E2E-JOURNEY-1: added `e2e/journey.spec.ts` for a full authenticated route journey across Today, Drill, Review, Study Night, Anatomy, Progress, and Settings with one core action per page.
- Added minimal E2E selector hooks for nav and route surfaces (`nav-*`, `review-start`, `review-empty`, `progress-stats`, `settings-root`, `anatomy-root`, `anatomy-pack-0`) to reduce brittle page targeting.
- TP-E2E-3: added `e2e/study-night-critical.spec.ts` for a deterministic single-user Study Night host flow (create room -> start -> pick category -> question phase).
- Added minimal Study Night test hooks (`study-night-create`, `study-night-start`, `study-night-phase`, `category-tile`, `study-night-question`) to stabilize E2E selectors without changing gameplay logic.
- TP-E2E-GUARD-1: added `e2e/helpers/requireEnv.ts` so missing required E2E env vars now fail fast by default, with optional skip mode via `E2E_ALLOW_SKIP=1`.
- TP-E2E-2: added `e2e/drill-critical.spec.ts` for login -> drill start -> answer-first-question flow with explicit step timeouts and skip-on-missing-seed behavior.
- TP-E2E-1: added opt-in Playwright setup with single-run scripts (`e2e`, `e2e:once`) configured for no retries and one worker.
- Added a minimal critical login spec (`e2e/critical.spec.ts`) that skips with a clear message when `E2E_EMAIL`/`E2E_PASSWORD` are not set.
- TP32: added minimal privacy-safe telemetry plumbing with `usage_events` SQL docs/migration scripts and a best-effort `trackEvent` helper that never blocks UX.
- Added event tracking touchpoints for Today, Drill, Study Night (create/join/finished), and Question Forge save using counts/prefix/type metadata only (no question text or answers).
- TP31: added `docs/security-checklist.md` summarizing route and table access expectations for `user`, `questions_editor`, and `admin` roles.
- Added `scripts/rls-sanity.mjs` anon-key read-only probe for Study Night protected tables (and questions anon-read expectation) and wired it into smoke/critical smoke checks.
- TP30: added a host-only Study Night diagnostics toggle with live realtime status, last snapshot refresh time, and last critical mutation result for in-room troubleshooting.
- TP29: hardened Study Night stability with snapshot refresh de-duplication, realtime re-subscribe resync throttling, and single-retry handling for transient network failures on critical room-state PATCH mutations.
- TP28: added `docs/release-checklist.md` with pre-demo checks, a 5-8 minute demo script, talking points, quick triage, and rollback notes.
- Added critical-path smoke mode via `npm run smoke:critical` (Study Night + auth loading/question-forge route guards) while keeping default smoke behavior unchanged.
- TP27: added `docs/runbook.md` with end-to-end V1 setup for Supabase + Vercel, required env vars, SQL migration order, Realtime replication tables, seeding, verification, and troubleshooting.
- TP26: added `docs/instructor-onboarding.md` with step-by-step instructor setup, role SQL snippet, policy checklist, verification steps, and troubleshooting notes.
- Added a Question Forge role/permissions status block with a safe non-destructive check (read probe + policy guidance) to surface onboarding issues quickly.
- TP25: added a Question Forge onboarding panel with concise authoring guidance and one-click "Start here" setup from top Coverage Gap.
- Added persistent onboarding dismiss/show controls via localStorage so instructors can hide help and reopen it later.
- TP24: added Question Forge local draft autosave (`qforge:draft`) with debounce, timestamp, and meaningful-content-only saves.
- Added restore/discard prompt for unsaved Question Forge drafts on load plus an unsaved-changes indicator and `beforeunload` guard.
- Save/new/edit reset flows now update dirty baselines and clear local draft state to prevent stale restores.
- TP23: added Finished Coach Review CTA "Drill my weak spots" to deep-link into `/drill` using the user's top missed prefix (or next-pick fallback).
- Drill deep links now include safe type routing logic (omit for roulette; use last non-roulette game type with fallback) and disable with guidance when no target exists.
- TP22: added Question Forge draft lint warnings (long prompt/fill answer, missing explanation fields, duplicate choices, and fill punctuation checks) in a QA Checks panel.
- Added a Review Queue panel that scans recent questions and flags likely QA issues, with one-click load into edit mode and refresh/loading/error states.
- TP21: added Question Forge templates by question type with prompt skeletons, choice placeholders, and explanation scaffolds.
- Added safe template apply controls (template select, overwrite toggle, apply button) that preserve existing content unless overwrite is enabled.
- Applying a template now focuses the prompt and shows a short "Template applied" confirmation.
- TP20: added Question Forge Coverage Gaps panel using blueprint targets + live DB counts to show top 10 missing blueprint leaves (current/target/gap).
- Added one-click "Write next" actions from gaps to preselect blueprint code and focus the prompt field, plus on-demand refresh/loading/error states.
- TP19: added Question Forge search/load/edit mode with keyword/prefix/type filters and selectable result rows for existing questions.
- Form now supports PATCH updates when editing an existing question, with clear Editing state, New Question reset, and Updated success feedback.
- Added questions SQL policy docs and copy/paste migration script for `questions_editor`/`admin` update permissions.
- TP18: added strong inline Question Forge validation (required fields, duplicate choice checks, and top summary) that blocks invalid saves.
- Added read-only Question Forge preview for prompt, choices/fill answer, and Answer/Why/Trap/Hook blocks to match saved structure.
- Added post-save Duplicate flow to clone the most recently saved question into a new draft for fast variant authoring.
- TP17b: built Question Forge V1 at `/admin/questions` with blueprint search/picker, MCQ/Reverse/Fill type tabs, and keyboard-friendly Save / Save & New flows.
- Question inserts now validate required fields, show clear success/error panels, and preserve blueprint/type on Save & New.
- Added questions SQL policy docs for `questions_editor`/`admin` insert access and expanded lightweight smoke assertions for Question Forge rendering/gating.
- TP17a: added `profiles.role` support (`user | questions_editor | admin`) in SQL docs with migration snippet.
- Added gated `/admin/questions` "Question Forge" entry route and admin-role checks in AppShell.
- Questions nav item now appears only for `admin` and `questions_editor`; unauthorized admin routes show a friendly access message.
- Study Night TP16: added deck health counts and host deck-health summary (MCQ/Reverse/Fill counts by category).
- Roulette picks now avoid empty category/type buckets; if a picked category has no available deck questions, the turn stays in pick phase with a clear inline message.
- Study Night TP15: added invite UX with Copy Code, Copy Invite Link, and Web Share support plus short copied/shared feedback.
- Added deep-link join support via `/game/study-night?join=CODE` with input prefill and one-time auto-join for authenticated users.
- Study Night TP14: added host-only Host Tools (Force Resync, End Game, Reset Room with inline confirmation) for stuck-state recovery.
- End Game now sets `study_rooms.status='finished'` and `study_room_state.phase='finished'`; Reset Room returns to lobby and clears score/marks/coach stats for all room players.
- Study Night TP13: persisted per-player Coach Review aggregates to `study_room_players.coach_stats` (SQL docs + migration snippet + update grant).
- Turn-resolution stats now write through to `coach_stats` and Finished Coach Review prefers persisted player stats with in-memory fallback.
- Study Night TP12: added a concise Finished-only Coach Review panel (per-player Correct/Total, top missed prefix, and short next-pick suggestions for the current user).
- Coach stats are tracked client-side per room at turn resolution time and are not shown during reveal.
- Study Night TP11: updated UI terminology from wedges to marks/badges and removed Trivial-Pursuit-specific wording in Study Night screens.
- Pick phase now renders neutral category progress tiles with earned indicators and disabled earned categories.
- Player and finished views now show earned-category chips with check marks and explicit progress counts toward the win target.
- Study Night TP10: hardened turn integrity by gating answer submission to the current turn player and showing waiting hints for others.
- Added local per-turn submit guards (`room:round:turn:question`) to block double-scoring and surface "Already answered" feedback.
- Added host-action guards/messages for Start/Advance and extra patch-target sanity checks in multiplayer update paths.
- Study Night TP8: added room-state `deck` and `deck_pos` support (SQL docs + migration snippets) for host-authoritative question rotation.
- Host start now prebuilds per-category/per-game-type question ID decks and initializes deck positions for synced multiplayer selection.
- Turn question selection now consumes `deck/deck_pos` first and advances position per key, with deterministic fallback when a deck bucket is empty.
- Study Night TP7: added player `last_seen_at` heartbeat updates every 15 seconds for reconnect-aware activity tracking.
- Added safe rejoin membership sync on room load so refresh/disconnect users are re-upserted if their player row is missing.
- Added lightweight `Active X / Total Y` presence hint in the room player panel.
- Study Night TP6: added `game_type_mode` room setting (`pick` or `roulette`) with create-room controls and SQL docs/migration snippets.
- Roulette mode now hides manual game-type selection and lets the host auto-select MCQ/Reverse/Fill with a simple no-repeat reroll rule.
- Pick/question UI now surfaces the active turn game type label for both modes.
- Study Night TP5: added host-configurable room settings (`win_wedges`, `duration_sec`, `question_count`) to room creation and SQL docs.
- Study Night runtime now uses room-level win/timer settings with backward-compatible defaults for older rooms.
- Study Night TP4: enforced Trivial Pursuit wedge win threshold via `WIN_WEDGES` with host finishing the room when any player reaches the target.
- Study Night pick phase now marks and disables categories already owned by the current turn player to encourage wedge variety.
- Study Night finished view now includes a final scoreboard with per-player score and wedge progress.
- Study Night TP3a: added Fill as a third per-turn mini-game option (`mcq`, `reverse`, `fill`) in the category pick phase.
- Study Night question phase now renders a fill-in text input for fill questions with normalized answer matching and Enter-to-submit behavior.
- Added fill question seed coverage for Study Night testing with canonical `blueprint_code` prefixes.
- Study Night TP2: added per-turn game type selection (`mcq` or `reverse`) in the pick phase, with room state persisted via `study_room_state.game_type`.
- Study Night question selection now filters by both canonical `blueprint_code` prefix and selected `question_type`, while keeping deterministic ordering.
- Reveal/question UI now surfaces the active game type so players can confirm the selected mini-game.

## 2026-02-19
- Gated auth/route debug logging behind dev-only helpers (`devLog`/`devWarn`) so production avoids `[AUTH]` guard noise.
- Added a smoke regression check (`scripts/auth-loading-regression.mjs`) to protect against protected-route session loading gates getting stuck.
- Added Study Night TP1 MVP scaffolding: multiplayer room routes, host-driven turn/phase loop, category wedges mapped to MBLEX blueprint prefixes, and shared Quickfire MCQ rounds.
- Added SQL docs for `study_rooms`, `study_room_players`, and `study_room_state` with RLS policies for host/player permissions.
- Added lightweight smoke coverage for Study Night routes and protected `/game` gating.
